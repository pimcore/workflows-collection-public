name: "Static analysis"

on:
  workflow_call:
    inputs:
      APP_ENV:
        required: true
        type: string
      PIMCORE_TEST:
        required: true
        type: string
      PRIVATE_REPO:
        required: true
        type: string
      PHP_VERSION:
        required: true
        type: string
      SYMFONY:
        required: false
        type: string
      DEPENDENCIES:
        required: true
        type: string
      EXPERIMENTAL:
        required: true
        type: string
      PIMCORE_VERSION:
        required: false
        type: string
      REQUIRE_ADMIN_BUNDLE:
        required: false
        type: string
        default: "true"
      COVERAGE:
        required: false
        type: string
        default: "none"
      COMPOSER_OPTIONS:
        required: false
        type: string
      PRIVATE_PACKAGIST_CANONICAL:
        required: false
        type: string
        default: "true"

    secrets:
      COMPOSER_PIMCORE_REPO_PACKAGIST_TOKEN:
        required: false
      SSH_PRIVATE_KEY_PIMCORE_DEPLOYMENTS_USER:
        required: false

jobs:
  static-analysis:
    name: "Static analysis with phpstan"
    runs-on: "ubuntu-latest"
    continue-on-error: ${{ inputs.EXPERIMENTAL == 'true' }}
    env:
      PIMCORE_PROJECT_ROOT: ${{ github.workspace }}
      APP_ENV: ${{ inputs.APP_ENV }}
      PIMCORE_TEST: ${{ inputs.PIMCORE_TEST }}
      PIMCORE_INSTANCE_IDENTIFIER: ${{ secrets.PIMCORE_CI_INSTANCE_IDENTIFIER }}
      PIMCORE_ENCRYPTION_SECRET: ${{ secrets.PIMCORE_CI_ENCRYPTION_SECRET }}
      PIMCORE_PRODUCT_KEY: ${{ secrets.PIMCORE_CI_PRODUCT_KEY }}

    steps:
      - name: "Checkout code"
        uses: "actions/checkout@v4"

      - name: "Install PHP"
        uses: "shivammathur/setup-php@v2"
        with:
          coverage: "${{ inputs.COVERAGE }}"
          php-version: "${{ inputs.PHP_VERSION }}"

      - name: "Setup Pimcore environment"
        env:
          REQUIRE_ADMIN_BUNDLE: "${{ inputs.REQUIRE_ADMIN_BUNDLE }}"
        run: |
            .github/ci/scripts/setup-pimcore-environment.sh

      - name: "Set Symfony version constraint in composer.json"
        env:
            SYMFONY_VERSION: "${{ inputs.SYMFONY }}"
        run: |
            if [ ! -z "$SYMFONY_VERSION" ]; then
              .github/ci/scripts/symfony-require-dev.sh
            fi
          
      - name: Install SSH Key # this is necessary for Composer to be able to clone source from pimcore/ee-pimcore
        if: ${{ inputs.PRIVATE_REPO == 'true' }}
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY_PIMCORE_DEPLOYMENTS_USER }}
          known_hosts: ".... we add this in the next step ;-)"

      - name: "Add authentication for private pimcore packages"
        if: ${{ inputs.PRIVATE_REPO == 'true' }}
        run: |
          composer config repositories.private-packagist '{"type": "composer", "url": "https://repo.pimcore.com/github-actions/", "canonical": ${{ inputs.PRIVATE_PACKAGIST_CANONICAL }}}'
          composer config --global --auth http-basic.repo.pimcore.com github-actions ${{ secrets.COMPOSER_PIMCORE_REPO_PACKAGIST_TOKEN }}

      - name: "Update Pimcore version"
        env:
          PIMCORE_VERSION: "${{ inputs.PIMCORE_VERSION }}"
          REQUIRE_ADMIN_BUNDLE: "${{ inputs.REQUIRE_ADMIN_BUNDLE }}"
        run: |
          if [ ! -z "$PIMCORE_VERSION" ]; then
                composer require --no-update pimcore/pimcore:"${PIMCORE_VERSION}"
          fi

      - name: "Get target branch information"
        id: branch-info
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ] || [ "${{ github.event_name }}" = "pull_request_target" ]; then
            TARGET_BRANCH="${{ github.event.pull_request.base.ref }}"
            echo "target_branch=$TARGET_BRANCH" >> $GITHUB_OUTPUT
          else
            TARGET_BRANCH="${{ github.ref_name }}"
            echo "target_branch=$TARGET_BRANCH" >> $GITHUB_OUTPUT
          fi

      - name: "Download Symfony6 freeze configuration"
        run: |
          mkdir -p config
          
          BRANCHES_TO_TRY=("symfony6-freeze" "develop" "main")
          SUCCESS=false
          
          for BRANCH in "${BRANCHES_TO_TRY[@]}"; do
            curl -s -H "Authorization: token ${{ github.token }}" \
                 -H "Accept: application/vnd.github.v3.raw" \
                 -o config/symfony6-freeze.json \
                 "https://api.github.com/repos/pimcore/workflows-collection-public/contents/config/symfony6-freeze.json?ref=$BRANCH"
            
            if [ $? -eq 0 ] && [ -f "config/symfony6-freeze.json" ] && [ -s "config/symfony6-freeze.json" ]; then
              echo "Successfully downloaded Symfony6 freeze configuration from branch: $BRANCH"
              SUCCESS=true
              break
            else
              rm -f config/symfony6-freeze.json 2>/dev/null
            fi
          done
          
          if [ "$SUCCESS" = false ]; then
            echo "Failed to download Symfony6 freeze configuration from any branch"
            echo "SYMFONY_FREEZE_INSTALLED=false" >> $GITHUB_ENV
            exit 0
          fi

      - name: "Check Symfony6 freeze configuration"
        env:
          TARGET_BRANCH: "${{ steps.branch-info.outputs.target_branch }}"
          REPO_NAME: "${{ github.repository }}"
        run: |
          CONFIG_FILE="config/symfony6-freeze.json"
          
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "SYMFONY_FREEZE_INSTALLED=false" >> $GITHUB_ENV
            exit 0
          fi
          
          REPO_SHORT_NAME=$(echo "$REPO_NAME" | cut -d'/' -f2)
          
          echo "Checking Symfony6 freeze for $REPO_SHORT_NAME:$TARGET_BRANCH"
          
          if command -v jq >/dev/null 2>&1; then
            if jq -e ".\"$REPO_SHORT_NAME\"" "$CONFIG_FILE" >/dev/null 2>&1; then
              if jq -e ".\"$REPO_SHORT_NAME\" | index(\"$TARGET_BRANCH\")" "$CONFIG_FILE" >/dev/null 2>&1; then
                echo "Installing pimcore/symfony-freeze:^6.0 for $REPO_SHORT_NAME:$TARGET_BRANCH"
              
                composer require --no-update pimcore/symfony-freeze:^6.0
                
                if [ $? -eq 0 ]; then
                  echo "Successfully added pimcore/symfony-freeze:^6.0"
                  echo "SYMFONY_FREEZE_INSTALLED=true" >> $GITHUB_ENV
                else
                  exit 1
                fi
              else
                echo "SYMFONY_FREEZE_INSTALLED=false" >> $GITHUB_ENV
              fi
            else
              echo "SYMFONY_FREEZE_INSTALLED=false" >> $GITHUB_ENV
            fi
          else
            echo "SYMFONY_FREEZE_INSTALLED=false" >> $GITHUB_ENV
            exit 1
          fi

      - name: "Install dependencies with Composer"
        uses: "ramsey/composer-install@v3"
        with:
          dependency-versions: "${{ inputs.DEPENDENCIES }}"
          composer-options: "${{ inputs.COMPOSER_OPTIONS }}"

      - name: "Run a static analysis with phpstan/phpstan"
        run: "vendor/bin/phpstan analyse --memory-limit=-1"

      - name: "Generate baseline file"
        if: ${{ failure() }}
        run: "vendor/bin/phpstan analyse --memory-limit=-1 --generate-baseline"

      - name: "Upload baseline file"
        if: ${{ failure() }}
        uses: actions/upload-artifact@v4
        with:
            name: phpstan-baseline.neon
            path: phpstan-baseline.neon
