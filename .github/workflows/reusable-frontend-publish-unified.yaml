name: "Reusable Frontend Publish Unified"

on:
  workflow_call:
    inputs:
      target-release:
        description: "Base version for canary releases (e.g., 2.4.0)"
        required: true
        type: string
      working-directory:
        description: "Working directory for npm commands"
        required: false
        type: string
        default: "./assets/studio"
      node-version:
        description: "Node.js version to use"
        required: false
        type: string
        default: "24"
      lint:
        description: "Run lint before build"
        required: false
        type: boolean
        default: true
      typecheck:
        description: "Run type checks before build"
        required: false
        type: boolean
        default: true
      lint-script:
        description: "NPM script to run for linting"
        required: false
        type: string
        default: "lint-fix"
      typecheck-script:
        description: "NPM script to run for type checks"
        required: false
        type: string
        default: "check-types"
      build-script:
        description: "NPM script to run for production build"
        required: false
        type: string
        default: "build"
      commit-lint-output:
        description: "Automatically commit lint fixes"
        required: false
        type: boolean
        default: true
      commit-build-output:
        description: "Automatically commit build output"
        required: false
        type: boolean
        default: true
      build-output-path:
        description: "Path (from repo root) to built assets to commit"
        required: false
        type: string
        default: "."
      registry-url:
        description: "NPM registry URL"
        required: false
        type: string
        default: "https://registry.npmjs.org"
      pre-publish-script:
        description: "npm script to run before publish (e.g., generate-types)"
        required: false
        type: string
        default: ""
    secrets:
      NPM_TOKEN:
        required: false

permissions:
  id-token: write
  contents: read

env:
  BRANCH_NAME: ${{ github.head_ref || github.ref_name }}

jobs:
  canary-build:
    if: github.event_name != 'push' || !startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    uses: pimcore/workflows-collection-public/.github/workflows/reusable-studio-frontend-build.yaml@reusable-workflows
    with:
      working-directory: ${{ inputs.working-directory }}
      node-version: ${{ inputs.node-version }}
      lint: ${{ inputs.lint }}
      typecheck: ${{ inputs.typecheck }}
      lint-script: ${{ inputs.lint-script }}
      typecheck-script: ${{ inputs.typecheck-script }}
      build-script: ${{ inputs.build-script }}
      commit-lint-output: ${{ inputs.commit-lint-output }}
      commit-build-output: ${{ inputs.commit-build-output }}
      build-output-path: ${{ inputs.build-output-path }}

  publish:
    needs: canary-build
    if: always() && (needs.canary-build.result == 'success' || needs.canary-build.result == 'skipped')
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ env.BRANCH_NAME }}
          repository: ${{ github.event.pull_request.head.repo.full_name || github.repository }}

      - name: Cache npm dependencies
        uses: actions/cache@v5
        with:
          path: ${{ inputs.working-directory }}/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        working-directory: ${{ inputs.working-directory }}
        run: npm ci

      - name: Run pre-publish script
        if: inputs.pre-publish-script != ''
        working-directory: ${{ inputs.working-directory }}
        run: npm run ${{ inputs.pre-publish-script }}

      - name: Determine version and tag
        id: version
        shell: bash
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF_NAME#v}"
            if [[ "$VERSION" == *"-"* ]]; then
              TAG="$(echo "${VERSION#*-}" | grep -oE '^[A-Za-z]+' | tr '[:upper:]' '[:lower:]')"
              TAG="${TAG:-latest}"
            else
              TAG="latest"
            fi
          else
            BASE="${{ inputs.target-release }}"
            BASE="${BASE%%-*}"
            VERSION="${BASE}-canary.$(date +'%Y%m%d-%H%M%S')-$(git rev-parse --short=7 HEAD)"
            TAG="canary"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Set up Node.js
        uses: actions/setup-node@v5
        with:
          node-version: ${{ inputs.node-version }}
          registry-url: ${{ inputs.registry-url }}

      - name: Set package version
        working-directory: ${{ inputs.working-directory }}
        run: npm version "${{ steps.version.outputs.version }}" --no-git-tag-version --allow-same-version

      - name: Publish to npm
        working-directory: ${{ inputs.working-directory }}
        run: npx npm@latest publish --provenance --tag "${{ steps.version.outputs.tag }}" --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
